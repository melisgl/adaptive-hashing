\ProvidesPackage {mglgrid}

\RequirePackage{etoolbox}

%%%% Language

\RequirePackage[UKenglish]{babel}
\renewcommand\UKenglishhyphenmins{22}
\hyphenpenalty=0
\frenchspacing


%%%% Profiling per page

%% \RequirePackage{atbegshi}
%% \newcommand\showtimer{%
%%   \message{^^Jtimer: \the\numexpr\the\pdfelapsedtime*1000/65536\relax}%
%%   \pdfresettimer}
%% \AtBeginDocument{\showtimer}
%% \AtBeginShipout {\showtimer}


%%%% amsthm must be loaded before cleveref and newtxmath

\@ifpackageloaded{amsmath}
  {}
  {%
    \@ifpackageloaded{cleveref}
      {\PackageError{Do not load cleveref before amsmath.}}
      {}
    \@ifpackageloaded{newtxmath}
      {\PackageError{Do not load newtxmath before amsmath.}}
      {}
    \RequirePackage{amsmath}}
\RequirePackage{amsthm}


%%%% Spacing

\def\debuglayout{0}

\ifnum \debuglayout = 1
  % Mark overfull boxes in output
  \setlength{\overfullrule}{5pt}
  \RequirePackage[showframe,showbaselines]{ground}
  %% \RequirePackage{lua-visual-debug}
\else
  \RequirePackage{ground}
  %% % Without the ground package
  %% \newcommand{\groundskip}{\baselineskip}
  %% \newcommand{\groundlevel}{}
  %% \RequirePackage{expl3}
  %% \ExplSyntaxOn
  %% \cs_new_eq:NN \ground@fptodim \fp_to_dim:n
  %% \ExplSyntaxOff
  %% \NewDocumentEnvironment {ground} {O{false} O{\groundprop} +b} {#3} {}
\fi

\RequirePackage{ifxetex}
\RequirePackage{ifdraft}
\ifpdftex
  \ifdraft%
      {\newcommand\textls[2][]{#2}}%
      {\RequirePackage[spacing=true]{microtype}}
\else
  \RequirePackage{microtype}
\fi


\RequirePackage[verbose=true,letterpaper]{geometry}
\AtBeginDocument{
  %% This works for both Letter paper (8.5 x 11 inches) and A4 (8.27 x
  %% 11.7 inches), but two columns look much better on Letter in
  %% general.
  \newgeometry{
    % textheight ~= paperwidth. KLUDGE: Slightly less to minimize
    % blank space below the last grounded line at the current
    % groundskip setting (which depends on the font size). Without
    % this kludge, stuff like display math and footnotes may visibly
    % extend much further down than normal text.
    textheight=8.45in,
    % This is paperwidth * 4/5 for Letter and * ~5/6 for A4.
    textwidth=6.8in,
    top=(\paperheight-8.45in)/2,
    footskip=\ground@fptodim{3*\groundskip},
    % We don't use these. Set them to 0 so that "Trim to Margins"
    % works better in PDF viewers.
    headheight=0pt,
    headsep=0pt,
    marginparwidth=0pt,
    marginparsep=0pt,
  }
  \setlength{\columnsep}{\ground@fptodim{2*\groundskip}}
}

%% \widowpenalty=10000
%% \clubpenalty=10000
%% \interfootnotelinepenalty=0


%%%% Document title

\newcommand{\subtitle}[1]{\def\@subtitle{#1}}

\RequirePackage{titling}

% https://tex.stackexchange.com/questions/130762/prl-style-horizontal-line-in-latex
\newcommand{\PRLsep}{%
  \noindent%
  \resizebox{0.4\linewidth}{0.1em}{$\bullet$}}

\def\@maketitle{%
  \newpage
  \null
  \begin{ground}
    % The numbers are tuned so that the title has \textwidth.
    {\centering \fontsize{16pt}{24pt} \titlefont \textls[108]{\fontdimen2\font=1.08ex\MakeUppercase{\@title}} \par}
    \ifdef{\@subtitle}
          {\vspace*{0.5\groundskip} \centering \PRLsep \vspace*{0.5\groundskip} \par \fontsize{13pt}{18pt} \titlefont { \textls[10]{\fontdimen2\font=0.8ex\@subtitle}} \par}
          {}
    {\vspace*{2\groundskip}\centering\fontsize{11pt}{14pt}\titlefont \@author \par}
  \end{ground}
  \vspace*{3\groundskip}}

\newcommand\authorname[1]{\fontsize{12pt}{14pt}\titlefont \textls[10]{\fontdimen2\font=0.8ex \itshape #1}}
\newcommand\authoremail[1]{\texttt{\normalsizerrr #1}}
\newcommand\authororg[1]{\textls[10]{\normalsizerrr #1}}


%%%% Abstract

\@ifclassloaded{article}%
  {\RequirePackage{quoting}
   \quotingsetup{vskip=\groundskip,indentfirst=false}
   \renewenvironment{abstract}{%
     \if@twocolumn
       \section*{\abstractname}%
     \else
       {\centering\normalfont\normalsize\sc\MakeLowercase{\abstractname}\par}
       \vspace{\groundskip}
       \ground
       \small
       \quoting
     \fi}
     {\if@twocolumn\else\endquoting\endground\fi}
  }%
  {}%


%%%% Titles of Chapters, *Sections, Figures, Tables

\newcommand{\titlefont}{}
\newcommand{\titleliningnums}[1]{#1}

\newcommand{\chapterstyle}{\color{gray!180}\normalsizerr}
\newcommand{\chaptertitle}[1]{\textls[180]{\MakeUppercase{#1}}}
%% \RequirePackage{fancyhdr}
%% \pagestyle{plain}
%% \fancyhead{}
%% %% % This letter spacing affects the headers after the first page of the
%% %% % bibliography.
%% %% \fancyhead[L]{\textls[150]{\leftmark}}
%% \renewcommand{\headrulewidth}{0pt}
%% \fancyhead[L]{}
%% \renewcommand{\chaptermark}[1]{\markboth{\MakeUppercase{#1}}{}}

\RequirePackage[explicit]{titlesec}
\RequirePackage{titling}
\titleformat{\chapter}[block]
            {}
            {\chapterstyle \liningnums{\thechapter} \quad \chaptertitle{#1}}
            {0pt}{}
            [{\rule[0.25\groundskip]{\textwidth}{0.2pt}}]
\titleformat{name=\chapter,numberless}[block]
            {}
            {{\chapterstyle \chaptertitle{#1}}}
            {0.5em}{}
            [{\rule[0.25\groundskip]{\textwidth}{0.2pt}}]
\titlespacing*{\chapter}{0pt}{0pt}{1\groundskip}


\titleformat{\section}[block]
            % Setup common to title label and title body (e.g "1.2 Body")
            {\normalfont\normalsize\scshape}
            % Label (may contain normal letters, e.g in the appendix);
            % hence the lowercasing. Also, the parbox makes the title
            % body have an indent matching paragraph and list indent.
            {\parbox{\groundskip}{\MakeLowercase{\thesection}}}
            % Horizontal space after the label and before the body
            {0pt}
            % Emit the body given as #1 (due to the explicit option above)
            {\textls[80]{\fontdimen2\font=0.7ex\MakeLowercase{#1}}}
\titlespacing*{\section}{0pt}{\groundskip}{\groundskip}


\titleformat{\subsection}[block]
            {\normalfont\normalsize}
            % Reduce the size of "A" in "A.1" by setting it in
            % smallcap lowercase.
            {\scshape\MakeLowercase{\thesubsection}}
            % Approximately match the space between the label and the
            % title body in section titles.
            {0.7\groundskip}
            {\emph{#1}}
\titlespacing*{\subsection}{0pt}{\groundskip}{\groundskip}

\titleformat{\subsubsection}[block]
            {\normalfont\normalsize}
            {\sc\MakeLowercase{\thesubsubsection}}
            {0.7\groundskip}
            {#1}
\titlespacing*{\subsubsection}{0pt}{\groundskip}{\groundskip}

\RequirePackage{titletoc}
\newcommand{\mgltocpage}{%
  \nobreak\hspace{1em}\nobreak\color{mglred}\textit{\thecontentspage}}
\contentsmargin{0pt}
\titlecontents{chapter}[1.5em]
              % Skip a line before numbered chapters except the first.
              {\ifnum 0\thecontentslabel<2 \else \addvspace{\groundskip}\fi}
              % Make bibliography section numbers like 3.A look nice
              % by making 'A' match oldstyle figures.
              {\contentslabel[\sc\MakeLowercase{\thecontentslabel}]{1.5em}%
                \sc\textls[100]}
              {\sc\textls[100]}
              {\mgltocpage}
\titlecontents{section}[3.8em]
              {}
              {\contentslabel[\sc\MakeLowercase{\thecontentslabel}]{2.3em}}
              {}
              {\mgltocpage}
\titlecontents{subsection}[6.1em]
              {}
              {\contentslabel[\sc\MakeLowercase{\thecontentslabel}]{2.3em}}
              {}
              {\mgltocpage}
\titlecontents{figure}[2.3em]
              {}
              {\contentslabel[\sc\MakeLowercase{\thecontentslabel}]{2.3em}}
              {}
              {\mgltocpage}
\titlecontents{table}[2.3em]
              {}
              {\contentslabel[\sc\MakeLowercase{\thecontentslabel}]{2.3em}}
              {}
              {\mgltocpage}

% https://tex.stackexchange.com/questions/121879/remove-spacing-between-per-chapter-figures-in-lof
% \patchcmd{<cmd>}{<search>}{<replace>}{<succes>}{<failure>}
\patchcmd{\@chapter}{\addtocontents{lof}{\protect\addvspace{10\p@}}}{}{}{}% LoF
\patchcmd{\@chapter}{\addtocontents{lot}{\protect\addvspace{10\p@}}}{}{}{}% LoT

%% Include the bibliography in the table of contents.
\RequirePackage[nottoc,notlot,notlof]{tocbibind}

%% Some numbered subsections are just not important enough to include
%% them in the toc.
\newcommand{\nocontentsline}[3]{}
\newcommand{\tocless}[2]{\bgroup\let\addcontentsline=\nocontentsline#1{#2}\egroup}


%%%% Beginning and end of chapters

\newcommand{\mglepigraph}[3]{%
  \begin{ground}
    \flushright
    \begin{minipage}[t]{#1\textwidth}
      \fontsize{10.25pt}{12.5pt}\selectfont
      #2
      \par\xdef\tpd{\the\prevdepth}
    \end{minipage}
    \par\prevdepth\tpd
    \vspace{0.5\groundskip}
    \emph{\titlefont #3}
  \end{ground}
  \vspace{\groundskip}}

\RequirePackage{lettrine}
\newcommand{\mgllettrine}[3]{%
  \noindent
  \lettrine[lines=3, loversize=\fontloversize, #1]
           {\titlefont\color{mglred}\smash{#2}}{\textls[100]{#3}}}

%% \newcommand{\mglconclusion}{%
%%   \mgllettrine{loversize=-0.05,lraise=0.15,lhang=0.1,
%%     findent=0.2em,nindent=-0.05em,slope=-0.35em}{\textit{\S}}{}
%% }

%% \newcommand{\mglconclusion}{%
%%   \mgllettrine{loversize=-0.05,lraise=0.15,lhang=1.2,
%%     findent=0.05em,nindent=0.31em,slope=0.0em}{\S}{}
%% }

\newcommand{\mglconclusion}{%
  \mgllettrine{loversize=-0.05,lraise=0.15,lhang=1.3,
    findent=0.28em,nindent=0.31em,slope=0.0em}{\S}{}
}

%% \newcommand{\mglconclusion}{%
%%   \mgllettrine{loversize=-0.25,lraise=0.26,lhang=1.2,
%%     findent=-0.10em,nindent=0.31em,slope=0.0em}{|}{}
%% }

\newcommand{\mglsep}[1][mgl.png]{%
  \vspace{\groundskip-\prevdepth}%
  {\centering\includegraphics[height=2\groundskip]{#1}\par}}


%%%% Fonts (with some options)

\RequirePackage[utf8]{inputenc}
\RequirePackage{setspace}

\newcommand\narrowslash{/}

%% % Times
%% \RequirePackage[p,osf]{newtx}
%% \renewcommand{\titlefont}{}
%% \RequirePackage{letltxmacro}
%% \LetLtxMacro\titleliningnums\liningnums
%% \RequirePackage[fontsize=10pt]{fontsize}
%% %% \baselineskip 12pt: (/ 12 10 1.208) = 0.99337
%% \setstretch{0.99337}

%% % Libertinus font
%% \RequirePackage[p,osf]{libertinus}
%% \RequirePackage[fontsize=10.20pt]{fontsize}
%% \setstretch{0.9438}
%% %% \RequirePackage[fontsize=12.5874pt]{fontsize}
%% %% \setstretch{1.18343}
%% \RequirePackage[libertine,vvarbb]{newtxmath}
%% \let\openbox\relax
%% \newcommand{\fontloversize}{0.08}

%% % Cochineal = Recent Crimson font (=Amari?) with fixes, extensions
%% \RequirePackage[p,osf]{cochineal}
%% %% \RequirePackage[fontsize=12.47003pt]{fontsize}
%% \RequirePackage[fontsize=10.5633pt]{fontsize}
%% \setstretch{1.05}
%% \RequirePackage[varqu,varl,var0,scale=0.93]{inconsolata}
%% \RequirePackage[scale=.95,type1]{cabin}
%% \RequirePackage[cochineal,vvarbb]{newtxmath}
%% \RequirePackage[cal=boondoxo]{mathalfa}
%% \let\openbox\relax
%% % (/ 12.67603 13.23523 1.02) = 0.93896973
%% \RequirePackage[p,osf,scaled=0.93896973]{ebgaramond}
%% \renewcommand{\titlefont}{\ebgaramond}
%% \renewcommand{\titleliningnums}[1]{{\liningnums{#1}}}
%% \newcommand{\fontloversize}{0.13}

% XCharter
\ifpdftex
  % With pdflatex, unicode-math is not supported.
  \RequirePackage[osf,scosf]{XCharter}
  % Hack for Arxiv, which has an old XCharter.
  \ifdef{\useproportional}{\useproportional}{}
  \RequirePackage[charter,smallerops,subscriptcorrection,
    varbb,scaled=1.05]{newtxmath}
  \DeclareMathAlphabet{\mathbfit}{T1}{bch}{b}{it}
  \RequirePackage[cal=cm,calscaled=0.93]{mathalfa}
  % (* (/ 13.5 12) (/ 11.2265 12)) = 1.0524843
  \RequirePackage[p,osf,scaled=1.0524843]{ebgaramond}
\else
  \RequirePackage[no-math]{fontspec}
  % (* (/ 13.5 12) (/ 11.2265 12)) = 1.0524843
  \RequirePackage[p,osf,scaled=1.0524843]{ebgaramond}
  \RequirePackage[xcharter,p,osdf,scosf,smallerops,subscriptcorrection,
    varbb,mathscale=1.05]{newtx}
\fi
\renewcommand{\titlefont}{\ebgaramond}
%% Charter has a very wide slash that looks terrible in A/B and I/O.
\renewcommand\narrowslash{%
  \raisebox{0.12em}{%
    \resizebox{0.35em}{0.58em}{%
      \kern0.08em%
      \reflectbox{$\bm\setminus$}}}}
\RequirePackage{letltxmacro}
\LetLtxMacro\titleliningnums\liningnums
% This has the same space usage as 10pt Times New Roman.
\RequirePackage[fontsize=9.2833pt]{fontsize}
%% \baselineskip: Times would have 12pt: (* (/ 17.86 18) (/ 12 9.283 1.208))
\setstretch{1.0689}
%% % This has the same x-height as 10pt Times New Roman.
%% \RequirePackage[fontsize=9.355416pt]{fontsize}
%% %% \baselineskip 12pt: (/ 12 9.355416 1.208)
%% \setstretch{1.0618}


%%%% Misc

\RequirePackage{anyfontsize}
\RequirePackage[title]{appendix}
\RequirePackage[shortlabels]{enumitem}
\setlist{nosep,leftmargin=\groundskip}


%%%% noindentafter.sty included because the version on Arxiv doesn't work

\RequirePackage{noindentafter}
\NoIndentAfterEnv{itemize}
\NoIndentAfterEnv{enumerate}
\NoIndentAfterEnv{proof}
\NoIndentAfterEnv{definition}
\NoIndentAfterEnv{theorem}
\NoIndentAfterEnv{proposition}
\NoIndentAfterEnv{corollary}
\NoIndentAfterEnv{lemma}
\NoIndentAfterEnv{approximation}
\NoIndentAfterEnv{assumption}
\NoIndentAfterEnv{remark}
\NoIndentAfterEnv{example}
\NoIndentAfterEnv{restatable}


%% Smaller bullets with hack for Arxiv
\ifdef{\tinyrrr}
      {\newlength{\mylen}
        \setbox1=\hbox{$\bullet$}\setbox2=\hbox{\tinyrrr$\bullet$}
        \setlength{\mylen}{\dimexpr0.5\ht1-0.5\ht2}
        \renewcommand\labelitemi{\raisebox{\mylen}{\tinyrrr$\bullet$}}}
      {\newlength{\mylen}
        \setbox1=\hbox{$\bullet$}\setbox2=\hbox{\scriptsize$\bullet$}
        \setlength{\mylen}{\dimexpr0.5\ht1-0.5\ht2}
        \renewcommand\labelitemi{\raisebox{\mylen}{\scriptsize$\bullet$}}}


%%%% Citations, links, references, footnotes

\RequirePackage[authoryear]{natbib}
\DeclareTextFontCommand{\textin}{\initials}
\RequirePackage{url}            % simple URL typesetting

\AtBeginDocument{
  \@ifpackageloaded{cleveref}{%
    \Crefformat{chapter}{\S#2\scshape{\MakeLowercase{#1}}#3}
    \Crefformat{section}{\S#2\scshape{\MakeLowercase{#1}}#3}
    \Crefrangeformat{section}{\S#3#1#4--#5#2#6}
    \Crefmultiformat{section}{\S#2#1#3}{ and~ \S#2#1#3}{, \S#2#1#3}{ and~ \S#2#1#3}
    \Crefformat{subsection}{\S#2\scshape{\MakeLowercase{#1}}#3}
    \Crefformat{subsubsection}{\S#2\scshape{\MakeLowercase{#1}}#3}
  }{}
}
